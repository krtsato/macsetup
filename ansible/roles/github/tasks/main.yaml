- name: Ensure GitHub CLI is installed
  ansible.builtin.shell: gh --version
  environment:
    PATH: /opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin
  register: gh_cli
  changed_when: false
  failed_when: gh_cli.rc != 0

- name: Check GitHub authentication status
  ansible.builtin.shell: gh auth status
  environment:
    PATH: /opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin
  register: gh_auth
  changed_when: false
  failed_when: false

- name: Prompt to run gh auth login if not logged in
  ansible.builtin.pause:
    prompt: "gh auth login が未完了です。別ターミナルで `gh auth login` を実行し、ブラウザ認証を完了したら Enter を押してください。"
  when: gh_auth.rc != 0

- name: Re-check GitHub authentication status
  ansible.builtin.shell: gh auth status
  environment:
    PATH: /opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin
  register: gh_auth_after
  changed_when: false
  failed_when: gh_auth_after.rc != 0

- name: Create and register GitHub SSH key via script
  ansible.builtin.shell: >
    ./scripts/setup-github-ssh.sh
    {{ '-t ' ~ github_ssh_key_type if github_ssh_key_type != 'ed25519' else '' }}
    {{ github_ssh_email if github_ssh_email else '' }}
  args:
    chdir: /Users/s11639/dev/me/macsetup
    creates: "{{ github_ssh_key_path }}"
  environment:
    PATH: /opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin
  register: github_ssh_result
  when: github_setup_ssh | bool
