- name: Determine macOS sudo password source
  ansible.builtin.set_fact:
    macos_password: "{{ sudo_pass | default(ansible_become_password, true) | default('', true) }}"

- name: Require sudo password for system preferences/NVRAM
  ansible.builtin.fail:
    msg: "macOS defaults (system) と NVRAM には sudo が必要です。--ask-become-pass か EXTRA_VARS=\"sudo_pass=...\" を渡してください。"
  when:
    - (
        defaults_settings
        | selectattr('become', 'defined')
        | selectattr('become', 'equalto', true)
        | list
        | length
        | int
      ) > 0
      or (nvram_settings | length | int) > 0
    - macos_password | length == 0

- name: Propagate macOS sudo password to become
  ansible.builtin.set_fact:
    ansible_become_password: "{{ macos_password }}"
  when: macos_password | length > 0

- name: Apply macOS defaults
  become: "{{ item.become | default(false) }}"
  community.general.osx_defaults:
    domain: "{{ item.domain }}"
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  loop: "{{ defaults_settings }}"

- name: Restart Dock to apply changes
  ansible.builtin.shell: killall Dock || true

- name: Restart Finder to apply changes
  ansible.builtin.shell: killall Finder || true

- name: Restart Control Center to apply changes
  ansible.builtin.shell: |
    killall ControlCenter || true
    killall SystemUIServer || true

- name: Read NVRAM values
  become: true
  ansible.builtin.command: /usr/sbin/nvram -p
  environment:
    PATH: /usr/sbin:/usr/bin:/bin
  register: nvram_dump
  changed_when: false
  when: nvram_settings | length > 0

- name: Ensure NVRAM settings
  become: true
  ansible.builtin.command: "/usr/sbin/nvram {{ item.key }}={{ item.value }}"
  environment:
    PATH: /usr/sbin:/usr/bin:/bin
  loop: "{{ nvram_settings }}"
  when:
    - nvram_settings | length > 0
    - (item.key ~ '\t' ~ item.value) not in nvram_dump.stdout
