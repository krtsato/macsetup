- name: Apply macOS defaults
  become: "{{ item.become | default(false) }}"
  community.general.osx_defaults:
    domain: "{{ item.domain }}"
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  loop: "{{ defaults_settings }}"

- name: Restart Dock to apply changes
  ansible.builtin.shell: killall Dock || true

- name: Restart Finder to apply changes
  ansible.builtin.shell: killall Finder || true

- name: Restart Control Center to apply changes
  ansible.builtin.shell: |
    killall ControlCenter || true
    killall SystemUIServer || true

- name: Read NVRAM values
  become: true
  ansible.builtin.command: nvram -p
  register: nvram_dump
  changed_when: false
  when: nvram_settings | length > 0

- name: Ensure NVRAM settings
  become: true
  ansible.builtin.command: "nvram {{ item.key }}={{ item.value }}"
  loop: "{{ nvram_settings }}"
  when:
    - nvram_settings | length > 0
    - (item.key ~ '\t' ~ item.value) not in nvram_dump.stdout
