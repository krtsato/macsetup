- name: Ensure base directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ lookup('env', 'HOME') }}/go/src/github.com"
    - "{{ lookup('env', 'HOME') }}/dev/job"
    - "{{ lookup('env', 'HOME') }}/dev/me"

- name: Ensure dotfiles repository is present
  ansible.builtin.shell: |
    if [ -d ~/dev/me/dotfiles/.git ]; then
      git -C ~/dev/me/dotfiles pull --ff-only
    else
      mkdir -p ~/dev/me
      git clone https://github.com/krtsato/dotfiles.git ~/dev/me/dotfiles
    fi
  environment:
    PATH: /opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin
  register: dotfiles_repo
  changed_when: "'Cloning into' in (dotfiles_repo.stdout + dotfiles_repo.stderr) or 'Updating' in (dotfiles_repo.stdout + dotfiles_repo.stderr) or 'Fast-forward' in (dotfiles_repo.stdout + dotfiles_repo.stderr)"
  failed_when: dotfiles_repo.rc != 0
